{% extends "base.html" %}

{% block title %}Preview Student Results{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="mb-6">
        <h2 class="text-2xl font-bold text-gray-800">
            <i class="fas fa-eye text-blue-600 mr-3"></i>Preview Student Data
        </h2>
        <p class="text-gray-600 mt-2">Review the data before sending emails to students</p>
    </div>

    <!-- Stats -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-users text-blue-600 text-3xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-gray-600 text-sm">Total Students</p>
                    <p class="text-2xl font-bold text-gray-800" id="totalStudents">0</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-envelope text-green-600 text-3xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-gray-600 text-sm">Valid Emails</p>
                    <p class="text-2xl font-bold text-gray-800" id="validEmails">0</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-chart-bar text-purple-600 text-3xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-gray-600 text-sm">Average Score</p>
                    <p class="text-2xl font-bold text-gray-800" id="avgScore">0</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex flex-col md:flex-row gap-4">
            <input type="text" id="searchInput" placeholder="Search by name or email..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button id="sendAllBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition">
                <i class="fas fa-paper-plane mr-2"></i>Send All Results
            </button>
        </div>
    </div>

    <!-- Table -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-100 border-b">
                    <tr>
                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">
                            <input type="checkbox" id="selectAll" class="rounded">
                        </th>
                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Name</th>
                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Email</th>
                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Score</th>
                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Subject</th>
                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Batch</th>
                    </tr>
                </thead>
                <tbody id="studentTable" class="divide-y">
                    <tr class="text-center py-8">
                        <td colspan="6" class="py-8 text-gray-500">
                            <i class="fas fa-spinner fa-spin mr-2"></i>Loading students...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="mt-6 flex gap-4">
        <button id="sendSelectedBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition disabled:opacity-50" disabled>
            <i class="fas fa-paper-plane mr-2"></i>Send Selected
        </button>
        <a href="/" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg transition">
            <i class="fas fa-arrow-left mr-2"></i>Back to Upload
        </a>
    </div>
</div>

<!-- Send Confirmation Modal -->
<div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
        <h3 class="text-xl font-bold text-gray-800 mb-4">
            <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>Confirm Send
        </h3>
        <p class="text-gray-700 mb-6">
            Are you sure you want to send results to <span id="confirmCount" class="font-bold">0</span> student(s)?
        </p>
        <div class="flex gap-4">
            <button id="confirmSendBtn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition">
                <i class="fas fa-check mr-2"></i>Yes, Send
            </button>
            <button id="cancelSendBtn" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition">
                <i class="fas fa-times mr-2"></i>Cancel
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    let allStudents = [];
    let selectedStudents = new Set();

    // Load students on page load
    async function loadStudents() {
        try {
            const response = await fetch('/api/students');
            const data = await response.json();
            
            if (data.success) {
                allStudents = data.data;
                displayStudents(allStudents);
                updateStats();
            }
        } catch (error) {
            showToast('Error loading students: ' + error.message, 'error');
        }
    }

    function displayStudents(students) {
        const tbody = document.getElementById('studentTable');
        
        if (students.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="py-8 text-center text-gray-500">No students found</td></tr>';
            return;
        }

        tbody.innerHTML = students.map(student => `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4">
                    <input type="checkbox" class="student-checkbox rounded" data-id="${student.id}">
                </td>
                <td class="px-6 py-4 text-sm text-gray-800">${student.name}</td>
                <td class="px-6 py-4 text-sm text-gray-600">${student.email}</td>
                <td class="px-6 py-4 text-sm font-semibold text-gray-800">${student.score}</td>
                <td class="px-6 py-4 text-sm text-gray-600">${student.subject || '-'}</td>
                <td class="px-6 py-4 text-sm text-gray-600">${student.batch || '-'}</td>
            </tr>
        `).join('');

        // Add event listeners to checkboxes
        document.querySelectorAll('.student-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', updateSelectedCount);
        });
    }

    function updateStats() {
        document.getElementById('totalStudents').textContent = allStudents.length;
        
        const validEmails = allStudents.filter(s => s.email && s.email.includes('@')).length;
        document.getElementById('validEmails').textContent = validEmails;
        
        const avgScore = allStudents.length > 0 
            ? (allStudents.reduce((sum, s) => sum + s.score, 0) / allStudents.length).toFixed(2)
            : 0;
        document.getElementById('avgScore').textContent = avgScore;
    }

    function updateSelectedCount() {
        selectedStudents.clear();
        document.querySelectorAll('.student-checkbox:checked').forEach(checkbox => {
            selectedStudents.add(parseInt(checkbox.dataset.id));
        });
        
        document.getElementById('sendSelectedBtn').disabled = selectedStudents.size === 0;
    }

    // Search functionality
    document.getElementById('searchInput').addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        const filtered = allStudents.filter(s => 
            s.name.toLowerCase().includes(query) || 
            s.email.toLowerCase().includes(query)
        );
        displayStudents(filtered);
    });

    // Select all checkbox
    document.getElementById('selectAll').addEventListener('change', (e) => {
        document.querySelectorAll('.student-checkbox').forEach(checkbox => {
            checkbox.checked = e.target.checked;
        });
        updateSelectedCount();
    });

    // Send buttons
    document.getElementById('sendAllBtn').addEventListener('click', () => {
        document.getElementById('confirmCount').textContent = allStudents.length;
        document.getElementById('confirmModal').classList.remove('hidden');
        selectedStudents.clear();
        allStudents.forEach(s => selectedStudents.add(s.id));
    });

    document.getElementById('sendSelectedBtn').addEventListener('click', () => {
        document.getElementById('confirmCount').textContent = selectedStudents.size;
        document.getElementById('confirmModal').classList.remove('hidden');
    });

    document.getElementById('cancelSendBtn').addEventListener('click', () => {
        document.getElementById('confirmModal').classList.add('hidden');
    });

    document.getElementById('confirmSendBtn').addEventListener('click', async () => {
        document.getElementById('confirmModal').classList.add('hidden');
        
        const btn = document.getElementById('confirmSendBtn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sending...';

        try {
            const response = await fetch('/api/send-results', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    student_ids: Array.from(selectedStudents)
                })
            });

            const data = await response.json();

            if (data.success) {
                showToast(`Emails sent: ${data.results.sent}, Failed: ${data.results.failed}`, 'success');
                setTimeout(() => {
                    window.location.href = '/logs';
                }, 2000);
            } else {
                showToast(data.message, 'error');
            }
        } catch (error) {
            showToast('Error sending results: ' + error.message, 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-check mr-2"></i>Yes, Send';
        }
    });

    // Load students on page load
    loadStudents();
</script>
{% endblock %}

