{% extends "base.html" %}

{% block title %}Upload Student Results{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Upload Section -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-lg shadow-md p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-upload text-blue-600 mr-3"></i>Upload Student Results
                </h2>
                
                <!-- File Upload Area -->
                <div class="mb-6">
                    <div id="dropZone" class="border-2 border-dashed border-blue-300 rounded-lg p-8 text-center cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition">
                        <i class="fas fa-cloud-upload-alt text-4xl text-blue-400 mb-4"></i>
                        <p class="text-gray-700 font-semibold mb-2">Drag and drop your file here</p>
                        <p class="text-gray-500 text-sm mb-4">or click to select a file</p>
                        <input type="file" id="fileInput" class="hidden" accept=".csv,.xlsx,.xls">
                        <p class="text-gray-400 text-xs">Supported formats: CSV, Excel (.xlsx, .xls)</p>
                    </div>
                </div>

                <!-- File Info -->
                <div id="fileInfo" class="hidden mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <p class="text-sm text-gray-700">
                        <i class="fas fa-file text-blue-600 mr-2"></i>
                        <span id="fileName"></span>
                    </p>
                </div>

                <!-- Upload Button -->
                <button id="uploadBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <i class="fas fa-arrow-up mr-2"></i>Upload File
                </button>

                <!-- Instructions -->
                <div class="mt-8 p-4 bg-gray-50 rounded-lg">
                    <h3 class="font-semibold text-gray-800 mb-3">
                        <i class="fas fa-info-circle text-blue-600 mr-2"></i>File Format Requirements
                    </h3>
                    <ul class="text-sm text-gray-700 space-y-2">
                        <li><strong>Required columns:</strong> name, email, score</li>
                        <li><strong>Optional columns:</strong> subject, batch</li>
                        <li><strong>Example:</strong></li>
                    </ul>
                    <table class="mt-3 w-full text-xs border-collapse">
                        <thead>
                            <tr class="bg-gray-200">
                                <th class="border p-2 text-left">name</th>
                                <th class="border p-2 text-left">email</th>
                                <th class="border p-2 text-left">score</th>
                                <th class="border p-2 text-left">subject</th>
                                <th class="border p-2 text-left">batch</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="border p-2">John Doe</td>
                                <td class="border p-2">john@example.com</td>
                                <td class="border p-2">85.5</td>
                                <td class="border p-2">Math</td>
                                <td class="border p-2">2024-A</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Info Section -->
        <div>
            <div class="bg-white rounded-lg shadow-md p-6 sticky top-8">
                <h3 class="text-lg font-bold text-gray-800 mb-4">
                    <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>How It Works
                </h3>
                <ol class="space-y-4 text-sm text-gray-700">
                    <li class="flex">
                        <span class="flex-shrink-0 flex items-center justify-center h-6 w-6 rounded-full bg-blue-600 text-white text-xs font-bold mr-3">1</span>
                        <span><strong>Upload</strong> your CSV or Excel file with student data</span>
                    </li>
                    <li class="flex">
                        <span class="flex-shrink-0 flex items-center justify-center h-6 w-6 rounded-full bg-blue-600 text-white text-xs font-bold mr-3">2</span>
                        <span><strong>Preview</strong> the data to ensure accuracy</span>
                    </li>
                    <li class="flex">
                        <span class="flex-shrink-0 flex items-center justify-center h-6 w-6 rounded-full bg-blue-600 text-white text-xs font-bold mr-3">3</span>
                        <span><strong>Send</strong> results to all students with one click</span>
                    </li>
                    <li class="flex">
                        <span class="flex-shrink-0 flex items-center justify-center h-6 w-6 rounded-full bg-blue-600 text-white text-xs font-bold mr-3">4</span>
                        <span><strong>Check</strong> email delivery logs and status</span>
                    </li>
                </ol>

                <div class="mt-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                    <p class="text-xs text-green-800">
                        <i class="fas fa-check-circle text-green-600 mr-2"></i>
                        <strong>Secure:</strong> All data is encrypted and stored securely
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');

    // Drag and drop
    dropZone.addEventListener('click', () => fileInput.click());
    
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('border-blue-500', 'bg-blue-50');
    });
    
    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('border-blue-500', 'bg-blue-50');
    });
    
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-blue-500', 'bg-blue-50');
        fileInput.files = e.dataTransfer.files;
        handleFileSelect();
    });

    fileInput.addEventListener('change', handleFileSelect);

    function handleFileSelect() {
        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            fileName.textContent = file.name;
            fileInfo.classList.remove('hidden');
            uploadBtn.disabled = false;
        }
    }

    uploadBtn.addEventListener('click', async () => {
        if (fileInput.files.length === 0) {
            showToast('Please select a file', 'error');
            return;
        }

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Uploading...';

        try {
            const response = await fetch('/api/upload', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                showToast(data.message, 'success');
                
                // Save students to database
                const saveResponse = await fetch('/api/save-students', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ students: data.data })
                });

                const saveData = await saveResponse.json();
                if (saveData.success) {
                    showToast('Data saved successfully! Redirecting to preview...', 'success');
                    setTimeout(() => {
                        window.location.href = '/preview';
                    }, 1500);
                }
            } else {
                showToast(data.message, 'error');
            }
        } catch (error) {
            showToast('Error uploading file: ' + error.message, 'error');
        } finally {
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = '<i class="fas fa-arrow-up mr-2"></i>Upload File';
        }
    });
</script>
{% endblock %}

